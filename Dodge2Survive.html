<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>Dodge Game with Fixed Circular Joystick</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    * {
      box-sizing: border-box;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    html, body {
      margin: 0; padding: 0;
      background: #111;
      color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100%;
      overflow: hidden;
    }
    #overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 20px;
      text-align: center;
      transition: opacity 0.3s ease;
    }
    #overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #overlayText {
      font-size: 22px;
      margin-bottom: 20px;
      max-width: 320px;
      line-height: 1.3;
      white-space: pre-line;
    }
    .btn {
      padding: 12px 28px;
      margin: 8px;
      font-size: 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
      min-width: 140px;
    }
    #btnPC {
      background: #3498db;
      color: white;
    }
    #btnPC:hover {
      background: #2980b9;
    }
    #btnMob {
      background: #2ecc71;
      color: black;
    }
    #btnMob:hover {
      background: #27ae60;
      color: white;
    }
    #restartBtn {
      background: #f1c40f;
      color: #111;
      display: none;
      min-width: 140px;
    }
    #restartBtn:hover {
      background: #d4ac0d;
    }
    #score {
      font-size: 20px;
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(0,0,0,0.4);
      padding: 8px 14px;
      border-radius: 6px;
      user-select: none;
      z-index: 10;
      transition: left 0.3s ease, right 0.3s ease;
    }
    #score.mobile {
      left: auto;
      right: 12px;
    }
    #container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
      width: 100%;
      height: 100%;
      padding: 12px;
      gap: 12px;
    }
    canvas {
      background: #222;
      border: 3px solid #fff;
      margin: 0;
      flex-shrink: 0;
      border-radius: 8px;
      user-select: none;
    }
    #ui {
      max-width: 240px;
      font-size: 16px;
      line-height: 1.4;
      white-space: pre-line;
      user-select: none;
      margin-top: 4px;
    }

    /* JOYSTICK STYLES */
    #joystickContainer {
      display: none;
      position: relative;
      width: 160px;
      height: 160px;
      background: #222;
      border: 3px solid #fff;
      border-radius: 50%;
      margin-top: 10px;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    #joystickBase {
      position: absolute;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      background: #444;
      opacity: 0.5;
      top: 0; left: 0;
    }
    #joystickStick {
      position: absolute;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: #0f0;
      top: 45px; /* center in 160px base: (160-70)/2=45 */
      left: 45px;
      transition: top 0.05s ease, left 0.05s ease;
      box-shadow: 0 0 10px #0f0;
      touch-action: none;
      user-select: none;
    }

    @media (max-width: 700px) {
      #ui { display: none; }
      #score { display: none; }
      #score.mobile { display: block; }
      #joystickContainer { display: block; }
      #container {
        justify-content: center;
        align-items: center;
        gap: 0;
      }
    }
  </style>
</head>
<body>

  <div id="overlay">
    <div id="overlayText">Choose your device</div>
    <button id="btnPC" class="btn">üñ•Ô∏è PC</button>
    <button id="btnMob" class="btn">üì± Mobile</button>
    <button id="restartBtn" class="btn">üîÅ Restart</button>
  </div>

  <div id="score">Score: 0s</div>

  <div id="container">
    <canvas id="gameCanvas" width="480" height="480"></canvas>
    <div id="ui">
      <div id="instructions">Avoid red squares for as long as possible.
Use arrow keys or WASD on PC.
Use joystick on mobile.</div>
    </div>
    <div id="joystickContainer">
      <div id="joystickBase"></div>
      <div id="joystickStick"></div>
    </div>
  </div>

<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  const overlay = document.getElementById("overlay");
  const overlayText = document.getElementById("overlayText");
  const btnPC = document.getElementById("btnPC");
  const btnMob = document.getElementById("btnMob");
  const restartBtn = document.getElementById("restartBtn");
  const scoreDiv = document.getElementById("score");
  const joystickContainer = document.getElementById("joystickContainer");
  const joystickStick = document.getElementById("joystickStick");

  const WIDTH = canvas.width, HEIGHT = canvas.height;
  const playerSize = 18, enemySize = 18; // slightly smaller boxes

  let player, enemies, keys = {};
  let enemySpeed, spawnInterval;
  let lastSpawn = 0, lastSpeedIncrease = 0;
  let startTime, gameOver = false, gameStarted = false;
  let isMobile = false;
  let waitingToStart = false;

  // Joystick variables
  const joystickRadius = 80;  // radius of joystick container
  const stickRadius = 35;     // radius of joystick stick (half of 70px width)
  let joystickPos = {x: joystickRadius, y: joystickRadius}; // center position fixed
  let dragging = false;
  let dragStart = null;

  function initGame() {
    player = { x: WIDTH/2 - playerSize/2, y: HEIGHT/2 - playerSize/2, speed: 3, dx: 0, dy: 0 };
    enemies = [];
    keys = {};
    enemySpeed = 1.5;
    spawnInterval = 2000;
    lastSpawn = 0;
    lastSpeedIncrease = 0;
    startTime = Date.now();
    gameOver = false;
  }

  function startGame() {
    if (gameStarted) return;
    initGame();
    gameStarted = true;
    waitingToStart = false;
    overlay.classList.add("hidden");
    restartBtn.style.display = "none";
    spawnEnemy();
    requestAnimationFrame(gameLoop);
  }

  function spawnEnemy() {
    const edge = Math.floor(Math.random() * 4);
    let x, y;
    switch (edge) {
      case 0: x = Math.random() * WIDTH; y = 0; break;
      case 1: x = Math.random() * WIDTH; y = HEIGHT; break;
      case 2: x = 0; y = Math.random() * HEIGHT; break;
      case 3: x = WIDTH; y = Math.random() * HEIGHT; break;
    }
    const angle = Math.random() * 2 * Math.PI;
    enemies.push({
      x, y,
      dx: Math.cos(angle) * enemySpeed,
      dy: Math.sin(angle) * enemySpeed,
      changeDirTimer: Math.random() * 3000 + 1000
    });
  }

  function updatePlayer() {
    if (isMobile) {
      // Use dx and dy already set by joystick
      player.x += player.dx;
      player.y += player.dy;
    } else {
      player.dx = 0; player.dy = 0;
      if (keys["ArrowUp"] || keys["w"]) player.dy = -player.speed;
      if (keys["ArrowDown"] || keys["s"]) player.dy = player.speed;
      if (keys["ArrowLeft"] || keys["a"]) player.dx = -player.speed;
      if (keys["ArrowRight"] || keys["d"]) player.dx = player.speed;
      player.x += player.dx;
      player.y += player.dy;
    }

    player.x = Math.max(0, Math.min(WIDTH - playerSize, player.x));
    player.y = Math.max(0, Math.min(HEIGHT - playerSize, player.y));
  }

  function updateEnemies(delta) {
    for (let e of enemies) {
      e.x += e.dx;
      e.y += e.dy;
      e.changeDirTimer -= delta;
      if (e.changeDirTimer <= 0) {
        const a = Math.random() * 2 * Math.PI;
        e.dx = Math.cos(a) * enemySpeed;
        e.dy = Math.sin(a) * enemySpeed;
        e.changeDirTimer = Math.random() * 3000 + 1000;
      }
      if (e.x <= 0 || e.x >= WIDTH - enemySize) e.dx *= -1;
      if (e.y <= 0 || e.y >= HEIGHT - enemySize) e.dy *= -1;
    }
  }

  function checkCollision(a, b) {
    return (
      a.x < b.x + enemySize &&
      a.x + playerSize > b.x &&
      a.y < b.y + enemySize &&
      a.y + playerSize > b.y
    );
  }

  function draw() {
    ctx.clearRect(0, 0, WIDTH, HEIGHT);

    // player
    ctx.fillStyle = "#0f0";
    ctx.fillRect(player.x, player.y, playerSize, playerSize);

    // enemies
    ctx.fillStyle = "#f00";
    enemies.forEach(e => ctx.fillRect(e.x, e.y, enemySize, enemySize));
  }

  function gameLoop(timestamp) {
    if (gameOver) return;
    const now = Date.now();
    const elapsed = now - startTime;
    const seconds = Math.floor(elapsed / 1000);
    scoreDiv.innerText = `Score: ${seconds}s`;

    updatePlayer();
    updateEnemies(16);

    if (now - lastSpawn > spawnInterval) {
      spawnEnemy();
      lastSpawn = now;
    }
    if (now - lastSpeedIncrease > 5000) {
      enemySpeed += 0.3;
      lastSpeedIncrease = now;
      if (spawnInterval > 500) spawnInterval -= 100;
    }

    for (let e of enemies) {
      if (checkCollision(player, e)) {
        gameOver = true;
        overlayText.innerText = `üí• Game Over!\nYou survived ${seconds} seconds.`;
        overlay.classList.remove("hidden");
        restartBtn.style.display = "inline-block";
        return;
      }
    }

    draw();
    requestAnimationFrame(gameLoop);
  }

  // Disable scrolling on arrow keys and spacebar
  window.addEventListener("keydown", e => {
    if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)) {
      e.preventDefault();
    }
  }, { passive: false });

  // Device selection and UI setup
  btnPC.addEventListener("click", () => {
    isMobile = false;
    waitingToStart = true;
    overlayText.innerText = "Press any key to start";
    btnPC.style.display = "none";
    btnMob.style.display = "none";
    restartBtn.style.display = "none";
    joystickContainer.style.display = "none";
    scoreDiv.classList.remove("mobile");
  });

  btnMob.addEventListener("click", () => {
    isMobile = true;
    waitingToStart = true;
    overlayText.innerText = "Use joystick to start";
    btnPC.style.display = "none";
    btnMob.style.display = "none";
    restartBtn.style.display = "none";
    joystickContainer.style.display = "block";
    scoreDiv.classList.add("mobile");
  });

  restartBtn.addEventListener("click", () => {
    overlayText.innerText = isMobile ? "Use joystick to start" : "Press any key to start";
    restartBtn.style.display = "none";
    waitingToStart = true;
    gameStarted = false;
    overlay.classList.remove("hidden");
  });

  // Keyboard input
  document.addEventListener("keydown", e => {
    keys[e.key] = true;
    if (waitingToStart && !gameStarted && !isMobile) {
      startGame();
    }
  });
  document.addEventListener("keyup", e => {
    keys[e.key] = false;
  });

  // JOYSTICK LOGIC
  function setStickPosition(x, y) {
    // Clamp stick within joystick radius circle
    const dx = x - joystickRadius;
    const dy = y - joystickRadius;
    const dist = Math.sqrt(dx*dx + dy*dy);
    const maxDist = joystickRadius - stickRadius; // max stick distance from center

    let clampedX = dx;
    let clampedY = dy;
    if (dist > maxDist) {
      const angle = Math.atan2(dy, dx);
      clampedX = Math.cos(angle) * maxDist;
      clampedY = Math.sin(angle) * maxDist;
    }
    joystickStick.style.left = (joystickRadius - stickRadius + clampedX) + "px";
    joystickStick.style.top = (joystickRadius - stickRadius + clampedY) + "px";

    // Normalize movement vector -1 to 1
    const normX = clampedX / maxDist;
    const normY = clampedY / maxDist;

    // Set player dx, dy proportional to normX and normY
    player.dx = normX * player.speed;
    player.dy = normY * player.speed;
  }

  function resetStick() {
    joystickStick.style.left = (joystickRadius - stickRadius) + "px";
    joystickStick.style.top = (joystickRadius - stickRadius) + "px";
    player.dx = 0;
    player.dy = 0;
  }

  joystickContainer.addEventListener("touchstart", e => {
    e.preventDefault();
    dragging = true;
    if (waitingToStart && !gameStarted) {
      startGame();
    }
    const touch = e.targetTouches[0];
    const rect = joystickContainer.getBoundingClientRect();
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    setStickPosition(x, y);
  }, { passive: false });

  joystickContainer.addEventListener("touchmove", e => {
    if (!dragging) return;
    e.preventDefault();
    const touch = e.targetTouches[0];
    const rect = joystickContainer.getBoundingClientRect();
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    setStickPosition(x, y);
  }, { passive: false });

  joystickContainer.addEventListener("touchend", e => {
    e.preventDefault();
    dragging = false;
    resetStick();
  }, { passive: false });

  joystickContainer.addEventListener("touchcancel", e => {
    dragging = false;
    resetStick();
  });

  // Prevent mouse scrolling when arrows pressed (for PC)
  window.addEventListener("keydown", e => {
    if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "].includes(e.key)) {
      e.preventDefault();
    }
  }, { passive: false
  });

  // For PC: Start game on any key press only if waiting to start
  window.addEventListener("keydown", e => {
    if (waitingToStart && !gameStarted && !isMobile) {
      startGame();
    }
  });

  // Prevent scrolling on touch for mobile joystick container
  joystickContainer.addEventListener("touchmove", e => {
    e.preventDefault();
  }, { passive: false });

  // On load: show overlay, reset UI
  function resetUI() {
    overlayText.innerText = "Choose your device";
    btnPC.style.display = "inline-block";
    btnMob.style.display = "inline-block";
    restartBtn.style.display = "none";
    joystickContainer.style.display = "none";
    scoreDiv.classList.remove("mobile");
    overlay.classList.remove("hidden");
    gameStarted = false;
    waitingToStart = false;
    player = null;
  }
  resetUI();

</script>

</body>
</html>
