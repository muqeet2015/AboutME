<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Dodge Game</title>
<style>
  html, body {
    margin: 0; padding: 0;
    background: #111;
    color: white;
    font-family: sans-serif;
    height: 100%;
    overflow: hidden;
    -webkit-user-select:none;
    -moz-user-select:none;
    -ms-user-select:none;
    user-select:none;
  }

  #container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    height: 100%;
    padding: 10px;
    box-sizing: border-box;
    position: relative;
  }

  canvas {
    background: #222;
    border: 3px solid #fff;
    border-radius: 8px;
    touch-action: none;
  }

  #ui {
    margin-left: 20px;
    width: 220px;
    user-select: none;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }

  #score {
    font-size: 22px;
    margin-bottom: 15px;
  }

  #instructions {
    font-size: 15px;
    white-space: pre-line;
    line-height: 1.4;
  }

  #overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 90vw;
    max-width: 600px;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.85);
    border: 2px solid #0f0;
    border-radius: 12px;
    padding: 20px 30px;
    text-align: center;
    font-size: 24px;
    color: #0f0;
    z-index: 10;
    user-select:none;
  }

  #overlay.hidden {
    display: none;
  }

  #deviceChoice button {
    background: #0f0;
    border: none;
    color: #000;
    font-weight: bold;
    font-size: 20px;
    padding: 12px 25px;
    margin: 0 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  #deviceChoice button:hover {
    background: #0c0;
  }
  #deviceChoice {
    margin-top: 20px;
  }

  #restartBtn {
    margin-top: 25px;
    padding: 12px 25px;
    font-size: 20px;
    background-color: #0f0;
    border: none;
    color: #000;
    cursor: pointer;
    border-radius: 8px;
    user-select:none;
    transition: background-color 0.2s ease;
    display: none;
  }
  #restartBtn:hover {
    background-color: #0c0;
  }

  #restartBtn:active {
    transform: scale(0.97);
  }

  /* Mobile score top-right */
  #score.mobile {
    position: fixed;
    top: 12px;
    right: 12px;
    background: rgba(0, 255, 0, 0.2);
    padding: 6px 14px;
    border-radius: 8px;
    font-size: 20px;
    z-index: 20;
    user-select:none;
  }

  /* Hide instructions on mobile */
  #instructions.mobile {
    display: none;
  }

  /* Joystick styles */
  #joystickContainer {
    position: fixed;
    bottom: 30px;
    left: 30px;
    width: 120px;
    height: 120px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    touch-action: none;
    user-select:none;
    display: none;
    z-index: 15;
  }
  #joystickBase {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: rgba(0,255,0,0.15);
  }
  #joystickStick {
    position: absolute;
    width: 60px;
    height: 60px;
    background: rgba(0,255,0,0.6);
    border-radius: 50%;
    top: 30px;
    left: 30px;
    touch-action: none;
  }

  @media (max-width: 768px) {
    #container {
      flex-direction: column;
      align-items: center;
      padding: 5px;
    }
    canvas {
      width: 90vw;
      height: 90vw;
      max-width: 600px;
      max-height: 600px;
    }
    #ui {
      display: none;
    }
  }
</style>
</head>
<body>
<div id="container">
  <canvas id="gameCanvas" width="600" height="600"></canvas>

  <div id="ui">
    <div id="score">Score: 0s</div>
    <div id="instructions">
      <strong>How to Play:</strong><br>
      Use arrow keys or WASD to move on PC.<br><br>
      On mobile, drag the joystick to move.<br><br>
      Avoid the red squares!<br><br>
      üíö Green = You<br>
      üî¥ Red = Enemies<br><br>
      Survive as long as possible!
    </div>
  </div>

  <div id="overlay">
    <div id="overlayText">
      Choose your device:
    </div>
    <div id="deviceChoice">
      <button id="btnPC">PC</button>
      <button id="btnMob">Mobile</button>
    </div>
    <button id="restartBtn">üîÅ Restart</button>
  </div>
</div>

<div id="joystickContainer">
  <div id="joystickBase"></div>
  <div id="joystickStick"></div>
</div>

<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  const scoreDiv = document.getElementById("score");
  const instructionsDiv = document.getElementById("instructions");
  const overlay = document.getElementById("overlay");
  const overlayText = document.getElementById("overlayText");
  const restartBtn = document.getElementById("restartBtn");
  const btnPC = document.getElementById("btnPC");
  const btnMob = document.getElementById("btnMob");
  const deviceChoice = document.getElementById("deviceChoice");
  const joystickContainer = document.getElementById("joystickContainer");
  const joystickStick = document.getElementById("joystickStick");

  const WIDTH = canvas.width;
  const HEIGHT = canvas.height;

  const playerSize = 16; // smaller
  const enemySize = 16;

  let player = null;
  let enemies = [];
  let keys = {};
  let lastSpawn = 0;
  let lastSpeedIncrease = 0;
  let enemySpeed = 1.5;
  let spawnInterval = 2000;
  let startTime = 0;
  let gameOver = false;
  let gameStarted = false;
  let waitingToStart = false;
  let isMobile = false;

  // Player movement velocity controlled by joystick or keys
  let moveX = 0;
  let moveY = 0;

  // --- Device Choice ---
  btnPC.onclick = () => {
    isMobile = false;
    overlayText.textContent = "Press any key to start";
    deviceChoice.style.display = "none";
    instructionsDiv.classList.remove("mobile");
    scoreDiv.classList.remove("mobile");
    joystickContainer.style.display = "none";
    waitingToStart = true;
  };

  btnMob.onclick = () => {
    isMobile = true;
    overlayText.textContent = "Tap joystick to start";
    deviceChoice.style.display = "none";
    instructionsDiv.classList.add("mobile");
    scoreDiv.classList.add("mobile");
    joystickContainer.style.display = "block";
    waitingToStart = true;
  };

  // --- Game Init ---
  function initGameState() {
    player = {
      x: WIDTH / 2 - playerSize / 2,
      y: HEIGHT / 2 - playerSize / 2,
      speed: 3,
      dx: 0,
      dy: 0,
    };

    enemies = [];
    keys = {};
    lastSpawn = 0;
    lastSpeedIncrease = 0;
    enemySpeed = 1.5;
    spawnInterval = 2000;
    startTime = Date.now();
    gameOver = false;
    moveX = 0;
    moveY = 0;
  }

  function startGame() {
    initGameState();
    gameStarted = true;
    waitingToStart = false;
    overlay.classList.add("hidden");
    restartBtn.style.display = "none";
    requestAnimationFrame(gameLoop);
  }

  // --- Player update ---
  function updatePlayer() {
    if (isMobile) {
      player.dx = moveX * player.speed;
      player.dy = moveY * player.speed;
    } else {
      player.dx = 0;
      player.dy = 0;

      if (keys["ArrowUp"] || keys["w"]) player.dy = -player.speed;
      if (keys["ArrowDown"] || keys["s"]) player.dy = player.speed;
      if (keys["ArrowLeft"] || keys["a"]) player.dx = -player.speed;
      if (keys["ArrowRight"] || keys["d"]) player.dx = player.speed;
    }

    player.x += player.dx;
    player.y += player.dy;

    player.x = Math.max(0, Math.min(WIDTH - playerSize, player.x));
    player.y = Math.max(0, Math.min(HEIGHT - playerSize, player.y));
  }

  // --- Enemy spawning and update ---
  function spawnEnemy() {
    const edge = Math.floor(Math.random() * 4);
    let x, y;

    switch (edge) {
      case 0: x = Math.random() * WIDTH; y = 0; break;
      case 1: x = Math.random() * WIDTH; y = HEIGHT; break;
      case 2: x = 0; y = Math.random() * HEIGHT; break;
      case 3: x = WIDTH; y = Math.random() * HEIGHT; break;
    }

    const angle = Math.random() * 2 * Math.PI;

    enemies.push({
      x,
      y,
      dx: Math.cos(angle) * enemySpeed,
      dy: Math.sin(angle) * enemySpeed,
      changeDirTimer: Math.random() * 3000 + 1000,
    });
  }

  function updateEnemies(deltaTime) {
    for (let enemy of enemies) {
      enemy.x += enemy.dx;
      enemy.y += enemy.dy;

      enemy.changeDirTimer -= deltaTime;
      if (enemy.changeDirTimer <= 0) {
        const angle = Math.random() * 2 * Math.PI;
        enemy.dx = Math.cos(angle) * enemySpeed;
        enemy.dy = Math.sin(angle) * enemySpeed;
        enemy.changeDirTimer = Math.random() * 3000 + 1000;
      }

      if (enemy.x <= 0 || enemy.x >= WIDTH - enemySize) enemy.dx *= -1;
      if (enemy.y <= 0 || enemy.y >= HEIGHT - enemySize) enemy.dy *= -1;
    }
  }

  // --- Collision check ---
  function checkCollision(a, b) {
    return (
      a.x < b.x + enemySize &&
      a.x + playerSize > b.x &&
      a.y < b.y + enemySize &&
      a.y + playerSize > b.y
    );
  }

  // --- Drawing ---
  function draw() {
    ctx.clearRect(0, 0, WIDTH, HEIGHT);

    // Player
    ctx.fillStyle = "#0f0";
    ctx.fillRect(player.x, player.y, playerSize, playerSize);

    // Enemies
    ctx.fillStyle = "#f00";
    for (let enemy of enemies) {
      ctx.fillRect(enemy.x, enemy.y, enemySize, enemySize);
    }
  }

  // --- Game loop ---
  function gameLoop(timestamp) {
    if (gameOver) return;

    const now = Date.now();
    const elapsed = now - startTime;
    const secondsSurvived = Math.floor(elapsed / 1000);
    scoreDiv.innerText = `Score: ${secondsSurvived}s`;

    const deltaTime = 16;

    updatePlayer();
    updateEnemies(deltaTime);

    if (now - lastSpawn > spawnInterval) {
      spawnEnemy();
      lastSpawn = now;
    }

    if (now - lastSpeedIncrease > 5000) {
      enemySpeed += 0.3;
      lastSpeedIncrease = now;
      if (spawnInterval > 500) spawnInterval -= 100;
    }

    for (let enemy of enemies) {
      if (checkCollision(player, enemy)) {
        gameOver = true;
        overlay.classList.remove("hidden");
        overlayText.textContent = `üí• Game Over!\nYou survived ${secondsSurvived} seconds.`;
        restartBtn.style.display = "inline-block";
        return;
      }
    }

    draw();

    if (!gameOver) requestAnimationFrame(gameLoop);
  }

  // --- Prevent scrolling when using keys ---
  window.addEventListener("keydown", (e) => {
    if (!gameStarted && waitingToStart && !isMobile) {
      startGame();
      return;
    }
    if (!isMobile) {
      keys[e.key] = true;
      if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d"].includes(e.key)) {
        e.preventDefault();
      }
    }
  }, {passive: false});

  window.addEventListener("keyup", (e) => {
    if (!isMobile) keys[e.key] = false;
  });

  // --- Restart button ---
  restartBtn.onclick = () => {
    overlayText.textContent = isMobile ? "Tap joystick to start" : "Press any key to start";
    restartBtn.style.display = "none";
    gameOver = false;
    gameStarted = false;
    waitingToStart = true;
    deviceChoice.style.display = "none"; // Don't show device choice again
    if(isMobile) joystickContainer.style.display = "block";
    else instructionsDiv.classList.remove("mobile");
  };

  // --- Joystick logic ---
  let joystickActive = false;
  let originX = 60; // center of joystick container (120/2)
  let originY = 60;
  let stickX = originX;
  let stickY = originY;
  let maxRadius = 50;

  function updateJoystickPosition(x, y) {
    const dx = x - originX;
    const dy = y - originY;
    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), maxRadius);
    const angle = Math.atan2(dy, dx);
    stickX = originX + dist * Math.cos(angle);
    stickY = originY + dist * Math.sin(angle);
    joystickStick.style.left = (stickX - joystickStick.offsetWidth / 2) + "px";
    joystickStick.style.top = (stickY - joystickStick.offsetHeight / 2) + "px";

    // Normalize movement to -1..1
    moveX = (stickX - originX) / maxRadius;
    moveY = (stickY - originY) / maxRadius;
  }

  function resetJoystick() {
    stickX = originX;
    stickY = originY;
    joystickStick.style.left = (originX - joystickStick.offsetWidth / 2) + "px";
    joystickStick.style.top = (originY - joystickStick.offsetHeight / 2) + "px";
    moveX = 0;
    moveY = 0;
  }

  joystickContainer.addEventListener("touchstart", (e) => {
    e.preventDefault();
    if (!gameStarted && waitingToStart) {
      startGame();
    }
    joystickActive = true;
    const rect = joystickContainer.getBoundingClientRect();
    const touch = e.touches[0];
    updateJoystickPosition(touch.clientX - rect.left, touch.clientY - rect.top);
  }, {passive:false});

  joystickContainer.addEventListener("touchmove", (e) => {
    if (!joystickActive) return;
    e.preventDefault();
    const rect = joystickContainer.getBoundingClientRect();
    const touch = e.touches[0];
    updateJoystickPosition(touch.clientX - rect.left, touch.clientY - rect.top);
  }, {passive:false});

  joystickContainer.addEventListener("touchend", (e) => {
    e.preventDefault();
    joystickActive = false;
    resetJoystick();
  }, {passive:false});

  // Also support mouse for testing on desktop
  joystickContainer.addEventListener("mousedown", (e) => {
    e.preventDefault();
    if (!gameStarted && waitingToStart) {
      startGame();
    }
    joystickActive = true;
    const rect = joystickContainer.getBoundingClientRect();
    updateJoystickPosition(e.clientX - rect.left, e.clientY - rect.top);
  });

  window.addEventListener("mousemove", (e) => {
    if (!joystickActive) return;
    const rect = joystickContainer.getBoundingClientRect();
    updateJoystickPosition(e.clientX - rect.left, e.clientY - rect.top);
  });

  window.addEventListener("mouseup", (e) => {
    if (!joystickActive) return;
    joystickActive = false;
    resetJoystick();
  });

</script>
</body>
</html>
