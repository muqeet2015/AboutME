<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Dodge Game</title>
  <style>
    * {
      box-sizing: border-box;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: #111;
      color: #eee;
      font-family: sans-serif;
      height: 100%;
      overflow: hidden;
    }
    #container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      width: 100%;
      height: 100%;
      padding: 10px;
      position: relative;
    }
    canvas {
      background: #222;
      border: 3px solid #fff;
      border-radius: 6px;
      touch-action: none;
    }
    #ui {
      margin-left: 20px;
      width: 200px;
      display: flex;
      flex-direction: column;
    }
    #instructions {
      font-size: 15px;
      line-height: 1.4;
      white-space: pre-line;
    }
    /* Overlay for device choice / game over */
    #overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 20px 30px;
      border: 2px solid #0f0;
      border-radius: 8px;
      text-align: center;
      z-index: 10;
      color: #0f0;
    }
    #overlay.hidden {
      display: none;
    }
    #deviceChoice button {
      background: #0f0;
      border: none;
      color: #000;
      padding: 12px 25px;
      margin: 0 10px;
      font-size: 18px;
      border-radius: 6px;
      cursor: pointer;
    }
    #deviceChoice button:hover {
      background: #0c0;
    }
    #restartBtn {
      margin-top: 20px;
      padding: 12px 25px;
      font-size: 18px;
      background: #0f0;
      border: none;
      color: #000;
      border-radius: 6px;
      cursor: pointer;
      display: none;
    }
    #restartBtn:hover {
      background: #0c0;
    }

    /* Score overlay on top of canvas */
    #score {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      color: #0f0;
      background: rgba(0,0,0,0.6);
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 20px;
      z-index: 5;
      pointer-events: none;
    }
    #score.mobile {
      /* same position over box, for mobile too */
    }

    /* Joystick on mobile, placed on right */
    #joystickContainer {
      position: fixed;
      bottom: 40px;
      right: 30px;
      width: 120px;
      height: 120px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      touch-action: none;
      display: none;
      z-index: 8;
    }
    #joystickBase {
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(0,255,0,0.15);
      border-radius: 50%;
    }
    #joystickStick {
      position: absolute;
      width: 60px;
      height: 60px;
      background: rgba(0,255,0,0.6);
      border-radius: 50%;
      top: 30px;
      left: 30px;
      touch-action: none;
    }

    @media (max-width: 700px) {
      #ui {
        display: none;
      }
      canvas {
        width: 90vw;
        height: 90vw;
        max-width: 600px;
        max-height: 600px;
      }
    }
  </style>
</head>
<body>
  <div id="container">
    <canvas id="gameCanvas" width="600" height="600"></canvas>
    <div id="ui">
      <div id="instructions">
        <strong>How to Play:</strong><br>
        Use Arrow keys or WASD (on PC).<br><br>
        On mobile, drag the joystick to move.<br><br>
        Avoid the red squares!<br>
        üíö You = Green square<br>
        üî¥ Enemies = Red squares<br><br>
        Survive as long as possible!
      </div>
    </div>
    <div id="overlay">
      <div id="overlayText">Choose your device</div>
      <div id="deviceChoice">
        <button id="btnPC">PC</button>
        <button id="btnMob">Mobile</button>
      </div>
      <button id="restartBtn">üîÅ Restart</button>
    </div>
    <div id="score">Score: 0s</div>
  </div>
  <div id="joystickContainer">
    <div id="joystickBase"></div>
    <div id="joystickStick"></div>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const overlay = document.getElementById("overlay");
    const overlayText = document.getElementById("overlayText");
    const deviceChoice = document.getElementById("deviceChoice");
    const btnPC = document.getElementById("btnPC");
    const btnMob = document.getElementById("btnMob");
    const restartBtn = document.getElementById("restartBtn");
    const scoreDiv = document.getElementById("score");
    const joystickContainer = document.getElementById("joystickContainer");
    const joystickStick = document.getElementById("joystickStick");

    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;

    const playerSize = 18;
    const enemySize = 18;

    let player = null;
    let enemies = [];
    let keys = {};
    let lastSpawn = 0;
    let lastSpeedIncrease = 0;
    let enemySpeed = 1.5;
    let spawnInterval = 2000;
    let startTime = 0;
    let gameOver = false;
    let gameStarted = false;
    let waitingToStart = false;
    let isMobile = false;

    let moveX = 0;
    let moveY = 0;

    // Device selection
    btnPC.onclick = () => {
      isMobile = false;
      overlayText.textContent = "Press any key to start";
      deviceChoice.style.display = "none";
      waitingToStart = true;
    };

    btnMob.onclick = () => {
      isMobile = true;
      overlayText.textContent = "Drag joystick to start";
      deviceChoice.style.display = "none";
      joystickContainer.style.display = "block";
      waitingToStart = true;
    };

    function initGame() {
      player = {
        x: WIDTH/2 - playerSize/2,
        y: HEIGHT/2 - playerSize/2,
        speed: 3,
        dx: 0,
        dy: 0
      };
      enemies = [];
      keys = {};
      lastSpawn = 0;
      lastSpeedIncrease = 0;
      enemySpeed = 1.5;
      spawnInterval = 2000;
      startTime = Date.now();
      gameOver = false;
      moveX = 0;
      moveY = 0;
    }

    function startGame() {
      initGame();
      gameStarted = true;
      waitingToStart = false;
      overlay.classList.add("hidden");
      restartBtn.style.display = "none";
      requestAnimationFrame(gameLoop);
    }

    function updatePlayer() {
      if (isMobile) {
        player.dx = moveX * player.speed;
        player.dy = moveY * player.speed;
      } else {
        player.dx = 0;
        player.dy = 0;
        if (keys["ArrowUp"] || keys["w"]) player.dy = -player.speed;
        if (keys["ArrowDown"] || keys["s"]) player.dy = player.speed;
        if (keys["ArrowLeft"] || keys["a"]) player.dx = -player.speed;
        if (keys["ArrowRight"] || keys["d"]) player.dx = player.speed;
      }
      player.x += player.dx;
      player.y += player.dy;
      player.x = Math.max(0, Math.min(WIDTH - playerSize, player.x));
      player.y = Math.max(0, Math.min(HEIGHT - playerSize, player.y));
    }

    function spawnEnemy() {
      const edge = Math.floor(Math.random() * 4);
      let x, y;
      switch(edge) {
        case 0: x = Math.random()*WIDTH; y = 0; break;
        case 1: x = Math.random()*WIDTH; y = HEIGHT; break;
        case 2: x = 0; y = Math.random()*HEIGHT; break;
        case 3: x = WIDTH; y = Math.random()*HEIGHT; break;
      }
      const angle = Math.random() * 2 * Math.PI;
      enemies.push({
        x, y,
        dx: Math.cos(angle)*enemySpeed,
        dy: Math.sin(angle)*enemySpeed,
        changeDirTimer: Math.random()*3000 + 1000
      });
    }

    function updateEnemies(delta) {
      for (let e of enemies) {
        e.x += e.dx;
        e.y += e.dy;
        e.changeDirTimer -= delta;
        if (e.changeDirTimer <= 0) {
          const angle = Math.random()*2*Math.PI;
          e.dx = Math.cos(angle)*enemySpeed;
          e.dy = Math.sin(angle)*enemySpeed;
          e.changeDirTimer = Math.random()*3000 + 1000;
        }
        if (e.x <= 0 || e.x >= WIDTH - enemySize) e.dx *= -1;
        if (e.y <= 0 || e.y >= HEIGHT - enemySize) e.dy *= -1;
      }
    }

    function checkCollision(a, b) {
      return (
        a.x < b.x + enemySize &&
        a.x + playerSize > b.x &&
        a.y < b.y + enemySize &&
        a.y + playerSize > b.y
      );
    }

    function draw() {
      ctx.clearRect(0,0,WIDTH,HEIGHT);
      ctx.fillStyle = "#0f0";
      ctx.fillRect(player.x, player.y, playerSize, playerSize);
      ctx.fillStyle = "#f00";
      for (let e of enemies) {
        ctx.fillRect(e.x, e.y, enemySize, enemySize);
      }
    }

    function gameLoop() {
      if (gameOver) return;
      const now = Date.now();
      const elapsed = now - startTime;
      const secs = Math.floor(elapsed / 1000);
      scoreDiv.textContent = `Score: ${secs}s`;

      updatePlayer();
      updateEnemies(16);

      if (now - lastSpawn > spawnInterval) {
        spawnEnemy();
        lastSpawn = now;
      }
      if (now - lastSpeedIncrease > 5000) {
        enemySpeed += 0.3;
        lastSpeedIncrease = now;
        if (spawnInterval > 500) spawnInterval -= 100;
      }

      for (let e of enemies) {
        if (checkCollision(player, e)) {
          gameOver = true;
          overlay.classList.remove("hidden");
          overlayText.textContent = `üí• Game Over!\nYou survived ${secs} seconds.`;
          restartBtn.style.display = "block";
          return;
        }
      }

      draw();
      requestAnimationFrame(gameLoop);
    }

    // Keyboard input
    window.addEventListener("keydown", e => {
      if (waitingToStart && !gameStarted && !isMobile) {
        startGame();
      }
      if (!isMobile) {
        keys[e.key] = true;
        if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)) {
          e.preventDefault();
        }
      }
    }, { passive: false });

    window.addEventListener("keyup", e => {
      if (!isMobile) {
        keys[e.key] = false;
      }
    });

    // Restart
    restartBtn.onclick = () => {
      overlayText.textContent = isMobile ? "Drag joystick to start" : "Press any key to start";
      restartBtn.style.display = "none";
      overlay.classList.remove("hidden");
      gameStarted = false;
      waitingToStart = true;
      if (isMobile) joystickContainer.style.display = "block";
    };

    // Joystick logic
    let active = false;
    const origin = { x: 60, y: 60 };
    const maxRadius = 50;

    function setStick(x, y) {
      const dx = x - origin.x;
      const dy = y - origin.y;
      let dist = Math.sqrt(dx*dx + dy*dy);
      if (dist > maxRadius) {
        const angle = Math.atan2(dy, dx);
        x = origin.x + Math.cos(angle)*maxRadius;
        y = origin.y + Math.sin(angle)*maxRadius;
        dist = maxRadius;
      }
      joystickStick.style.left = (x - joystickStick.offsetWidth/2) + "px";
      joystickStick.style.top = (y - joystickStick.offsetHeight/2) + "px";

      moveX = (x - origin.x) / maxRadius;
      moveY = (y - origin.y) / maxRadius;
    }

    function resetStick() {
      joystickStick.style.left = (origin.x - joystickStick.offsetWidth/2) + "px";
      joystickStick.style.top = (origin.y - joystickStick.offsetHeight/2) + "px";
      moveX = 0;
      moveY = 0;
    }

    joystickContainer.addEventListener("touchstart", e => {
      e.preventDefault();
      if (waitingToStart && !gameStarted && isMobile) {
        startGame();
      }
      active = true;
      const rect = joystickContainer.getBoundingClientRect();
      const t = e.touches[0];
      setStick(t.clientX - rect.left, t.clientY - rect.top);
    }, { passive: false });

    joystickContainer.addEventListener("touchmove", e => {
      if (!active) return;
      e.preventDefault();
      const rect = joystickContainer.getBoundingClientRect();
      const t = e.touches[0];
      setStick(t.clientX - rect.left, t.clientY - rect.top);
    }, { passive: false });

    joystickContainer.addEventListener("touchend", e => {
      e.preventDefault();
      active = false;
      resetStick();
    }, { passive: false });

    joystickContainer.addEventListener("touchcancel", e => {
      e.preventDefault();
      active = false;
      resetStick();
    });

    // Also allow click for testing
    joystickContainer.addEventListener("mousedown", e => {
      e.preventDefault();
      if (waitingToStart && !gameStarted && isMobile) {
        startGame();
      }
      active = true;
      const rect = joystickContainer.getBoundingClientRect();
      setStick(e.clientX - rect.left, e.clientY - rect.top);
    });
    window.addEventListener("mousemove", e => {
      if (!active) return;
      const rect = joystickContainer.getBoundingClientRect();
      setStick(e.clientX - rect.left, e.clientY - rect.top);
    });
    window.addEventListener("mouseup", e => {
      if (!active) return;
      active = false;
      resetStick();
    });

  </script>
</body>
</html>
